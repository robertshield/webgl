<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Place favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- CSS: implied media="all" -->
  <link rel="stylesheet" href="css/style.css?v=2">

  <!-- Uncomment if you are specifically targeting less enabled mobile browsers
  <link rel="stylesheet" media="handheld" href="css/handheld.css?v=2">  -->

  <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
  <script src="js/libs/modernizr-1.7.min.js"></script>
  
  <style type="text/css"> 
      body {
        background-color: #000000;
        margin: 0px;
        overflow: hidden;
      }
      .main {
        overflow: hidden;
      }
   </style>

</head>
<body>
  
  <div id="container">
    <header>

    </header>
    <div id="main" role="main">

    </div>
    <footer>

    </footer>
  </div> <!--! end of #container -->
  
  <!-- JavaScript at the bottom for fast page loading -->

  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write("<script src='js/libs/jquery-1.5.1.min.js'>\x3C/script>")</script>
    

  <script type="text/javascript" src="js/libs/ThreeDebug.js"></script>

  <script type="text/javascript" src="js/libs/RequestAnimationFrame.js"></script>
  <script type="text/javascript" src="js/libs/Stats.js"></script>
  
  <script type="text/javascript" src="js/fonts/helvetiker_bold.typeface.js"></script>
  <script type="text/javascript" src="js/fonts/helvetiker_regular.typeface.js"></script>

  <!-- TODO:
    X - 1) Finish the sorted range list impl. + test.
    2) get selection glow / state
    3) target tracking
    4) animation
    5) ship creation.
    6) Refactor this to not suck horribly.
  
    -->

  <script type="text/javascript" src="js/worlds.js"></script>

  <script type="text/javascript">

    var container, stats;
    var camera, scene;
    var textScene;
    var projector, renderer;
    var skyboxCamera, skyboxScene;

    var mouse = { x: 0, y: 0 };
    var g_intersecting_world;
    
    // TODO: Make this a range instead.
    var WORLD_RADIUS = 20;
    var WORLD_COUNT = 75;
    
    var UNSELECTED_COLOUR = 0x777777;
    var SELECTED_COLOUR = 0x00FF00;

    var g_game_state = new Game.State();

    init();
    animate();

    function init() {
      var info = document.createElement( 'div' );
      info.style.position = 'absolute';
      info.style.top = '10px';
      info.style.width = '100%';
      info.style.textAlign = 'center';
      info.innerHTML = 'webgl - test';
      $("#main")[0].appendChild( info );

      camera = new THREE.Camera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
      //camera = new THREE.Camera( 90, 1, 1, 10000 );
      //camera = new THREE.FlyCamera({
      //camera = new THREE.QuakeCamera({
/*
        fov: 25,
        aspect: window.innerWidth / window.innerHeight,
        movementSpeed: 1000,
        domElement: container,
        rollSpeed: Math.PI / 24,
        autoForward: false,
        dragToLook: false,
        near: 50,
        far: 1e7,
        lookVertical: false,
          });
*/
      camera.target.position.x = 0;
      camera.target.position.y = 0;
      camera.target.position.z = 0;
      camera.position.x = 0;
      camera.position.y = 0;
      camera.position.z = 900;

      skyboxCamera = new THREE.Camera( 60, window.innerWidth / window.innerHeight, 1, 100000 );
      skyboxScene = new THREE.Scene();

      scene = new THREE.Scene();
      overlayScene = new THREE.Scene();

      var light = new THREE.DirectionalLight( 0xffffff, 2 );
      light.position.x = 1;
      light.position.y = 1;
      light.position.z = 1;
      light.position.normalize();
      scene.addLight( light );

      var light = new THREE.DirectionalLight( 0xffffff );
      light.position.x = - 1;
      light.position.y = - 1;
      light.position.z = - 1;
      light.position.normalize();
      scene.addLight( light );

      scene.addLight( light );

      var geometry = new THREE.SphereGeometry(WORLD_RADIUS, 20, 20);
      var textGeometry = new THREE.TextGeometry( '100', { size: 12, height: 1, curveSegments: 24 } );

      var worlds = g_game_state.generateWorldPositions(WORLD_RADIUS, WORLD_COUNT, -400, 400, -400, 400, 0, 0);

      for (var i = worlds.length - 1; i >= 0; i--) {
        var x = worlds[i].x, y = worlds[i].y, z = worlds[i].z;
        
        var globe = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( { color: 0x777777 } ) );
        globe.position.x = x;
        globe.position.y = y;
        globe.position.z = z;
        scene.addObject( globe );

        var textParent = new THREE.Object3D();
        textParent.position.x = x;
        textParent.position.y = y;
        textParent.position.z = z;
        textParent.rotation.x = -Math.atan((camera.position.y - y) / (camera.position.z - z));
        textParent.rotation.y = Math.atan((camera.position.x - x) / (camera.position.z - z));
        textParent.rotation.z = 0;

        var text = new THREE.Mesh( textGeometry, new THREE.MeshLambertMaterial( { color: 0xffffff } ) );
        text.position.x = 0
        text.position.y = 0;
        text.position.z = WORLD_RADIUS + 4;
        textParent.addChild(text);

        var world = new Game.World(worlds[i], WORLD_RADIUS, 100, globe, text);
        globe.world = world;
        g_game_state.addWorld(world);

        overlayScene.addObject(textParent);
      }

      // Skybox
      var path = "img/skybox/";
      var format = '.jpg';
      var urls = [
        path + 'px' + format, path + 'nx' + format,
        path + 'py' + format, path + 'ny' + format,
        path + 'pz' + format, path + 'nz' + format
      ];

      var textureCube = THREE.ImageUtils.loadTextureCube( urls );
      var material = new THREE.MeshBasicMaterial( { color: 0xffffff, envMap: textureCube } );
      var shader = THREE.ShaderUtils.lib["cube"];
      shader.uniforms["tCube"].texture = textureCube;

      var material = new THREE.MeshShaderMaterial( {

        fragmentShader: shader.fragmentShader,
        vertexShader: shader.vertexShader,
        uniforms: shader.uniforms

      } );

      var skybox = new THREE.Mesh( new THREE.CubeGeometry( 100000, 100000, 100000, 1, 1, 1, null, true ), material );
      skybox.name = 'skybox';

      skyboxScene.addObject( skybox );

      projector = new THREE.Projector();

      renderer = new THREE.WebGLRenderer();
      renderer.sortObjects = false;
      renderer.autoClear = false;
      renderer.setSize( window.innerWidth, window.innerHeight );

      $("#main")[0].appendChild(renderer.domElement);

      stats = new Stats();
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.top = '0px';
      $("#main")[0].appendChild( stats.domElement );

      document.addEventListener( 'mousemove', onDocumentMouseMove, false );
      document.addEventListener( 'click', onDocumentMouseClick, false );
    }

    function onDocumentMouseMove( event ) {
      event.preventDefault();
      mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
      mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

    }
    
    function onDocumentMouseClick(event) {
      event.preventDefault();
      if (g_intersecting_world) {
        if (g_intersecting_world.world.isSelected()) {
          g_intersecting_world.world.setSelected(false);
          g_intersecting_world.materials[ 0 ].color.setHex(UNSELECTED_COLOUR);
        } else {
          g_intersecting_world.world.setSelected(true);
          g_intersecting_world.materials[ 0 ].color.setHex(SELECTED_COLOUR);
        }
      }
    }
    

    //

    function animate() {

      requestAnimationFrame( animate );

      render();
      stats.update();

    }

    var radius = 600;
    var theta = 0;

    function render() {

      theta += 0.2;
      //camera.position.x = radius * Math.sin( theta * Math.PI / 360 );
      //camera.position.y = radius * Math.sin( theta * Math.PI / 360 );
      //camera.position.z = radius * Math.cos( theta * Math.PI / 360 );

      //skyboxCamera.target.position.x = - camera.position.x;
      //skyboxCamera.target.position.y = - camera.position.y;
      //skyboxCamera.target.position.z = - camera.position.z;
      //skyboxCamera.update();

      // find intersections

      camera.update();
      
      
      
      for ( i = 0, l = overlayScene.objects.length; i < l; i ++ ) {
  
        var obj = overlayScene.objects[i];
        obj.rotation.x = - Math.atan( (camera.position.y - obj.position.y) / (camera.position.z - obj.position.z) );
        obj.rotation.y = Math.atan( (camera.position.x - obj.position.x) / (camera.position.z - obj.position.z) );    
      }

      // Compute the projected mouse cursor location
      var vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 );
      projector.unprojectVector( vector, camera );

      // Look for an intersecting planet, highlight it.
      var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
      var intersects = ray.intersectScene( scene );
      if ( intersects.length > 0 ) {

        if ( g_intersecting_world != intersects[ 0 ].object ) {
          g_intersecting_world = intersects[ 0 ].object;
          g_intersecting_world.currentHex = g_intersecting_world.materials[ 0 ].color.hex;
          g_intersecting_world.materials[ 0 ].color.setHex( 0xff0000 );
        }
      } else {
        if ( g_intersecting_world ) g_intersecting_world.materials[ 0 ].color.setHex( g_intersecting_world.world.getColour() );
        g_intersecting_world = null;
      }

      // If we have an active selection, render tracking lines from it to other planets.
      if (g_intersecting_world) {
        var selected_worlds = g_game_state.getSelectedWorlds();
        for (var i = selected_worlds.length - 1; i >= 0; i--) {
          // Draw line between here and g_intersecting_world.
        }
      }

      renderer.clear();
      renderer.render( skyboxScene, skyboxCamera );
      renderer.render( scene, camera );
      renderer.render( overlayScene, camera );

    }

  </script>

  <!-- scripts concatenated and minified via ant build script-->
  <script src="js/plugins.js"></script>
  <script src="js/script.js"></script>
  <!-- end scripts-->


  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script>DD_belatedPNG.fix("img, .png_bg"); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->

  <!-- mathiasbynens.be/notes/async-analytics-snippet Change UA-XXXXX-X to be your site's ID -->
  <script>
    var _gaq=[["_setAccount","UA-24911228-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

</body>
</html>
