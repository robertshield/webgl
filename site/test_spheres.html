<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Place favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- CSS: implied media="all" -->
  <link rel="stylesheet" href="css/style.css?v=2">

  <!-- Uncomment if you are specifically targeting less enabled mobile browsers
  <link rel="stylesheet" media="handheld" href="css/handheld.css?v=2">  -->

  <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
  <script src="js/libs/modernizr-1.7.min.js"></script>
  
  <style type="text/css"> 
      body {
        background-color: #000000;
        margin: 0px;
        overflow: hidden;
      }
      .main {
        overflow: hidden;
      }
   </style>

</head>
<body>
  
  <div id="container">
    <header>

    </header>
    <div id="main" role="main">

    </div>
    <footer>

    </footer>
  </div> <!--! end of #container -->
  
  <!-- JavaScript at the bottom for fast page loading -->

  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write("<script src='js/libs/jquery-1.5.1.min.js'>\x3C/script>")</script>
    

  <script type="text/javascript" src="js/libs/ThreeDebug.js"></script>

  <script type="text/javascript" src="js/libs/RequestAnimationFrame.js"></script>
  <script type="text/javascript" src="js/libs/Stats.js"></script>
  
  <script type="text/javascript" src="js/fonts/helvetiker_bold.typeface.js"></script>
  <script type="text/javascript" src="js/fonts/helvetiker_regular.typeface.js"></script>

  <!-- TODO:
    X - 1) Finish the sorted range list impl. + test.
    2) get selection glow / state
    3) target tracking
    4) animation
    5) ship creation.
    6) Refactor this to not suck horribly.
  
    -->

  <script type="text/javascript" src="js/worlds.js"></script>

  <script type="text/javascript">

    var container, stats;
    var g_camera, g_scene;
    var textScene;
    var g_projector, renderer;
    var g_skybox_camera, g_skybox_scene;

    var mouse = { x: 0, y: 0 };
    var g_intersecting_world;
    
    // TODO: Make this a range instead.
    var WORLD_RADIUS = 20;
    var WORLD_COUNT = 42;
    
    var UNSELECTED_COLOUR = 0x777777;
    var SELECTED_COLOUR = 0x00FF00;
    var TRACE_OFFSET = WORLD_RADIUS + 3;
    var OVERLAY_OFFSET = WORLD_RADIUS + 6;

    var g_game_state = new Game.State();
    var g_world_coordinates = [];
    var g_world_screen_coordinates = [];

    init();
    animate();

    function copyVector3(vector3) {
      return new THREE.Vector3(vector3.x, vector3.y, vector3.z);
    }

    // The thinking here is this:
    // for every world coordinate
    //   1) project it into view space using projector.projectVector. This
    //      assumes that the camera's projection matrix is up to date (meaning
    //      that camera.update() has been called).
    //   2) transform the view space ([-1,1]) to screen space ([0,width|height])
    //      for the x,y coordinates by using the mapping
    //      Sx = Vx * width / 2 + width / 2
    //      Sy = Vy * -1 * height / 2 + height / 2
    //      Sz = 0
    function calcScreenCoordinates(world_coordinates, camera, projector) {
      var viewport_to_screen_mult = new THREE.Vector3(window.innerWidth / 2,
                                                      -1 * (window.innerHeight / 2),
                                                      0);
      var viewport_to_screen_add = new THREE.Vector3(window.innerWidth / 2,
                                                     window.innerHeight / 2,
                                                     0);
      var screen_coordinates = [];
      for (var i = world_coordinates.length - 1; i >= 0; i--) {
        var viewport_coord = projector.projectVector(
            copyVector3(world_coordinates[i]), camera);
        viewport_coord.multiplySelf(viewport_to_screen_mult);
        var screen_coord = viewport_coord.addSelf(viewport_to_screen_add);
        screen_coordinates.unshift(screen_coord);
      }
      return screen_coordinates;
    }

    function init() {
      var info = document.createElement( 'div' );
      info.style.position = 'absolute';
      info.style.top = '10px';
      info.style.width = '100%';
      info.style.textAlign = 'center';
      info.style.zIndex = 100;
      info.innerHTML = 'webgl - test';
      $("#main")[0].appendChild( info );

      g_camera = new THREE.Camera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
      //g_camera = new THREE.Camera( 90, 1, 1, 10000 );
      //g_camera = new THREE.FlyCamera({
      //g_camera = new THREE.QuakeCamera({
/*
        fov: 25,
        aspect: window.innerWidth / window.innerHeight,
        movementSpeed: 1000,
        domElement: container,
        rollSpeed: Math.PI / 24,
        autoForward: false,
        dragToLook: false,
        near: 50,
        far: 1e7,
        lookVertical: false,
          });
*/
      g_camera.target.position.x = 0;
      g_camera.target.position.y = 0;
      g_camera.target.position.z = 0;
      g_camera.position.x = 0;
      g_camera.position.y = 0;
      g_camera.position.z = 900;
      g_camera.update();

      g_skybox_camera = new THREE.Camera( 60, window.innerWidth / window.innerHeight, 1, 100000 );
      g_skybox_scene = new THREE.Scene();

      g_scene = new THREE.Scene();
      g_overlay_scene = new THREE.Scene();

      g_projector = new THREE.Projector();

      var light = new THREE.DirectionalLight( 0xffffff, 2 );
      light.position.x = 1;
      light.position.y = 1;
      light.position.z = 1;
      light.position.normalize();
      g_scene.addLight( light );

      var light = new THREE.DirectionalLight( 0xffffff );
      light.position.x = - 1;
      light.position.y = - 1;
      light.position.z = - 1;
      light.position.normalize();
      g_scene.addLight( light );

      g_scene.addLight( light );

      var geometry = new THREE.SphereGeometry(WORLD_RADIUS, 20, 20);
      var textGeometry = new THREE.TextGeometry( '100', { size: 12, height: 1, curveSegments: 24 } );

      g_world_coordinates = g_game_state.generateWorldPositions(WORLD_RADIUS, WORLD_COUNT, -400, 400, -400, 400, 0, 0);

      for (var i = g_world_coordinates.length - 1; i >= 0; i--) {
        var x = g_world_coordinates[i].x, y = g_world_coordinates[i].y, z = g_world_coordinates[i].z;

        var globe = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( { color: 0x777777 } ) );
        globe.position.x = x;
        globe.position.y = y;
        globe.position.z = z;
        g_scene.addObject( globe );

        var world = new Game.World(g_world_coordinates[i], WORLD_RADIUS, 100, globe, null);
        globe.world = world;
        g_game_state.addWorld(world);
      }

      // Calculate the screen coordinates used for text overlays.
      // TODO: if this works, remove the text geometry above.
      var screen_coordinates = calcScreenCoordinates(g_world_coordinates, g_camera, g_projector);
      for (var i = screen_coordinates.length - 1; i >= 0; i--) {
        var label = document.createElement( 'div' );
        label.style.position = 'absolute';
        // TODO: the coords are fudged for now until I figure out how to center dom elements. Fix this.
        label.style.left = Math.round(screen_coordinates[i].x) - 20 + 'px';
        label.style.top = Math.round(screen_coordinates[i].y) - 20+ 'px';
        label.style.zIndex = 10;
        label.style.color = 'white';
        label.style.fontSize = '14pt';
        label.style.fontFamily = 'Arial';
        
        label.innerHTML = '100';
        $("#main")[0].appendChild(label);
      }

      // Skybox
      var path = "img/skybox/";
      var format = '.jpg';
      var urls = [
        path + 'px' + format, path + 'nx' + format,
        path + 'py' + format, path + 'ny' + format,
        path + 'pz' + format, path + 'nz' + format
      ];

      var textureCube = THREE.ImageUtils.loadTextureCube(urls);
      var material = new THREE.MeshBasicMaterial( { color: 0xffffff, envMap: textureCube } );
      var shader = THREE.ShaderUtils.lib["cube"];
      shader.uniforms["tCube"].texture = textureCube;

      var material = new THREE.MeshShaderMaterial( {

        fragmentShader: shader.fragmentShader,
        vertexShader: shader.vertexShader,
        uniforms: shader.uniforms

      } );

      var skybox = new THREE.Mesh(new THREE.CubeGeometry( 100000, 100000, 100000, 1, 1, 1, null, true ), material);
      skybox.name = 'skybox';

      g_skybox_scene.addObject( skybox );

      renderer = new THREE.WebGLRenderer();
      renderer.sortObjects = false;
      renderer.autoClear = false;
      renderer.domElement.style.zIndex = -1;
      renderer.setSize( window.innerWidth, window.innerHeight );

      $("#main")[0].appendChild(renderer.domElement);

      stats = new Stats();
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.top = '0px';
      $("#main")[0].appendChild( stats.domElement );

      document.addEventListener( 'mousemove', onDocumentMouseMove, false );
      document.addEventListener( 'click', onDocumentMouseClick, false );
    }

    function onDocumentMouseMove( event ) {
      event.preventDefault();
      mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
      mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

    }
    
    function onDocumentMouseClick(event) {
      event.preventDefault();
      if (g_intersecting_world) {
        if (g_intersecting_world.world.isSelected()) {
          g_intersecting_world.world.setSelected(false);
          g_intersecting_world.materials[ 0 ].color.setHex(UNSELECTED_COLOUR);
        } else {
          g_intersecting_world.world.setSelected(true);
          g_intersecting_world.materials[ 0 ].color.setHex(SELECTED_COLOUR);
        }
      }
    }
    

    function animate() {
      requestAnimationFrame( animate );
      render();
      stats.update();
    }

    function buildLineObject(start, end) {
      var geometry = new THREE.Geometry();
      var start_vertex = new THREE.Vertex(copyVector3(start));
      start_vertex.position.z = TRACE_OFFSET;
      geometry.vertices.push(start_vertex);
      geometry.colors.push(new THREE.Color(SELECTED_COLOUR));

      var end_vertex = new THREE.Vertex(copyVector3(end));
      end_vertex.position.z = TRACE_OFFSET;
      geometry.vertices.push(end_vertex);
      geometry.colors.push(new THREE.Color(UNSELECTED_COLOUR));

      var material = new THREE.LineBasicMaterial( { color: 0xffffff,
                                                    opacity: 1,
                                                    linewidth: 3,
                                                    vertexColors: true } );
      var line = new THREE.Line(geometry, material);
      return line;
    }

    function render() {
      for ( i = 0, l = g_overlay_scene.objects.length; i < l; i ++ ) {
  
        var obj = g_overlay_scene.objects[i];
        obj.rotation.x = - Math.atan( (g_camera.position.y - obj.position.y) / (g_camera.position.z - obj.position.z) );
        obj.rotation.y = Math.atan( (g_camera.position.x - obj.position.x) / (g_camera.position.z - obj.position.z) );    
      }

      // Compute the projected mouse cursor location
      var vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 );
      g_projector.unprojectVector( vector, g_camera );

      // Look for an intersecting planet, highlight it.
      var ray = new THREE.Ray( g_camera.position, vector.subSelf( g_camera.position ).normalize() );
      var intersects = ray.intersectScene( g_scene );
      if ( intersects.length > 0 ) {

        if ( g_intersecting_world != intersects[ 0 ].object ) {
          g_intersecting_world = intersects[ 0 ].object;
          g_intersecting_world.currentHex = g_intersecting_world.materials[ 0 ].color.hex;
          g_intersecting_world.materials[ 0 ].color.setHex( 0xff0000 );
        }
      } else {
        if ( g_intersecting_world ) g_intersecting_world.materials[ 0 ].color.setHex( g_intersecting_world.world.getColour() );
        g_intersecting_world = null;
      }

      // If we have an active selection, render tracking lines from it to other planets.
      var generated_scene = new THREE.Scene();
      if (g_intersecting_world) {
        var selected_worlds = g_game_state.getSelectedWorlds();
        for (var i = selected_worlds.length - 1; i >= 0; i--) {
          // Draw line between here and g_intersecting_world.
          var line = buildLineObject(selected_worlds[i].pos, g_intersecting_world.world.pos);
          generated_scene.addObject(line);
        }
      }

      renderer.clear();
      renderer.render(g_skybox_scene, g_skybox_camera);
      renderer.render(g_scene, g_camera);
      renderer.render(generated_scene, g_camera);
      renderer.render(g_overlay_scene, g_camera);
    }

  </script>

  <!-- scripts concatenated and minified via ant build script-->
  <script src="js/plugins.js"></script>
  <script src="js/script.js"></script>
  <!-- end scripts-->


  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script>DD_belatedPNG.fix("img, .png_bg"); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->

  <!-- mathiasbynens.be/notes/async-analytics-snippet Change UA-XXXXX-X to be your site's ID -->
  <script>
    var _gaq=[["_setAccount","UA-24911228-1"],["_trackPageview"]];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
    s.parentNode.insertBefore(g,s)}(document,"script"));
  </script>

</body>
</html>
